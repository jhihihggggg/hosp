{% extends 'base.html' %}
{% load static %}

{% block title %}Lab Report - {{ order.order_number }}{% endblock %}

{% block extra_css %}
<style>
.report-card{border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);}
.result-high{color:#dc3545;font-weight:700}
.result-low{color:#e08f0a;font-weight:700}
.result-normal{color:#198754;font-weight:700}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row mb-3">
    <div class="col-8">
      <h3>Lab Report - {{ order.order_number }}</h3>
      <p class="text-muted">Patient: <strong>{{ patient.full_name }}</strong></p>
    </div>
    <div class="col-4 text-end">
      <a href="{% url 'lab:report_print' order.id %}" class="btn btn-outline-primary" target="_blank"><i class="fas fa-print"></i> Print</a>
      {% if not order.results.first.is_verified %}
      <button class="btn btn-success" onclick="verifyReport({{ order.id }})">Verify</button>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="report-card">
        {% for result in order.results.all %}
        <div class="mb-3">
          <h5>{{ result.test.test_name }}</h5>
          <div class="row">
            <div class="col-md-4">
              <strong>Result:</strong>
              {% for k,v in result.result_data.items %}
                <div>{{ k }}: <span class="{% if v.status == 'high' %}result-high{% elif v.status == 'low' %}result-low{% else %}result-normal{% endif %}">{{ v.value }}</span> {{ v.unit|default:'' }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              <strong>Reference:</strong>
              <div>{{ result.test.reference_range|default:'N/A' }}</div>
            </div>
            <div class="col-md-4">
              <strong>Interpretation:</strong>
              <div>{{ result.interpretation|default:'-' }}</div>
            </div>
          </div>
        </div>
        <hr>
        {% endfor %}

        <div class="mt-3">
          <strong>Overall Comments:</strong>
          <p>{{ order.results.first.interpretation|default:'' }}</p>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
function verifyReport(id){
  if(confirm('Verify this report?')){
    fetch(`/lab/result/${id}/verify/`,{method:'POST',headers:{'X-CSRFToken':'{{ csrf_token }}'}}).then(()=>location.reload())
  }
}
</script>
{% endblock %}